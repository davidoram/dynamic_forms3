<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.5.3" />
<title>Dynamic_forms3</title>
<style type="text/css">
/* Debug borders */
p, li, dt, dd, div, pre, h1, h2, h3, h4, h5, h6 {
/*
  border: 1px solid red;
*/
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

tt {
  color: navy;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  font-family: sans-serif;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}

div.sectionbody {
  font-family: serif;
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}

pre {
  padding: 0;
  margin: 0;
}

span#author {
  color: #527bbd;
  font-family: sans-serif;
  font-weight: bold;
  font-size: 1.1em;
}
span#email {
}
span#revnumber, span#revdate, span#revremark {
  font-family: sans-serif;
}

div#footer {
  font-family: sans-serif;
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
div#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
div#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

div#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.tableblock, div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-family: sans-serif;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid silver;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid silver;
  background: #f4f4f4;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #dddddd;
  color: #777777;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-family: sans-serif;
  font-weight: bold;
}
tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}


@media print {
  div#footer-badges { display: none; }
}

div#toc {
  margin-bottom: 2.5em;
}

div#toctitle {
  color: #527bbd;
  font-family: sans-serif;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}
/* Workarounds for IE6's broken and incomplete CSS2. */

div.sidebar-content {
  background: #ffffee;
  border: 1px solid silver;
  padding: 0.5em;
}
div.sidebar-title, div.image-title {
  color: #527bbd;
  font-family: sans-serif;
  font-weight: bold;
  margin-top: 0.0em;
  margin-bottom: 0.5em;
}

div.listingblock div.content {
  border: 1px solid silver;
  background: #f4f4f4;
  padding: 0.5em;
}

div.quoteblock-attribution {
  padding-top: 0.5em;
  text-align: right;
}

pre.verseblock-content {
  font-family: inherit;
}
div.verseblock-attribution {
  padding-top: 0.75em;
  text-align: left;
}

div.exampleblock-content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

/* IE6 sets dynamically generated links as visited. */
div#toc a:visited { color: blue; }
</style>
<script type="text/javascript">
/*<![CDATA[*/
window.onload = function(){asciidoc.footnotes(); asciidoc.toc(2);}
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([2-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  var cont = document.getElementById("content");
  var noteholder = document.getElementById("footnotes");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      // Use [\s\S] in place of . so multi-line matches work.
      // Because JavaScript has no s (dotall) regex flag.
      note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      spans[i].innerHTML =
        "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
        "' title='View footnote' class='footnote'>" + n + "</a>]";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
}

}
/*]]>*/
</script>
</head>
<body>
<div id="header">
<h1>Dynamic_forms3</h1>
<span id="author">David Oram</span><br />
<span id="revnumber">version 1.0,</span>
<span id="revdate">2011-09</span>
<div id="toc">
  <div id="toctitle">Table of Contents</div>
  <noscript><p><b>JavaScript must be enabled in your browser to display the table of contents.</b></p></noscript>
</div>
</div>
<div id="content">
<h2 id="_preface">Preface</h2>
<div class="sectionbody">
<div class="paragraph"><p>The design of dynamic_forms3 (df3)  has been preceded by the authors thought into the attendant problems of
designing, implementing maintaining and enhancing procurement systems, along with the considerable
influence of colleagues at the MSI.</p></div>
</div>
<h1 id="_part_1_overview">Part 1 - Overview</h1>
<h2 id="_approach">Approach</h2>
<div class="sectionbody">
<div class="paragraph"><p>df3 takes the approach of separating the tasks of designing a form processing system, which provides forms
that provide a means to capture data into documents.  Documents can be pushed through a workflow
which supports a business process.</p></div>
<div class="paragraph"><p>The initial design does not concern itself with anything beyond these requirements, but that having been said,
the system has been created with the aim of solving problems in the <em>procurement</em> business domain.</p></div>
</div>
<h2 id="_architecture">Architecture</h2>
<div class="sectionbody">
<div class="paragraph"><p>The system provides the means for end users to design, test and publish Forms.  Then users fill out the Forms which result in
Document instances that conform to the layout and structure dictated in the Form.</p></div>
<div class="paragraph"><p>The system stores all of its data in JSON format.</p></div>
<div class="paragraph"><p>Permanent Data is stored in CouchDB.</p></div>
<div class="paragraph"><p>Clients run JavaScript enabled browsers.</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>+---------+               +-----------+               +---------+
| Browser |    &lt;------&gt;   | Webserver |    &lt;------&gt;   | CouchDB |
+---------+               +-----------+               +---------+
                               |
                               |
                               v
                             Static files, generated files</tt></pre>
</div></div>
<h3 id="_documents">Documents</h3><div style="clear:left"></div>
<div class="paragraph"><p>Each Document instance is represented by a JSON document, which in turn is stored in CouchDB. The process of editing a Document
involves retrieving the Document, and Form from CouchDB, then rendering the Document through the Form and updating changes
to the Document instance on the browser, and finally sending the edited Document back to stored in CouchDB.</p></div>
<h3 id="_forms">Forms</h3><div style="clear:left"></div>
<div class="paragraph"><p>Each Form is split into Sections. A Sections generally fits on a page, has a heading and the various form elements such
as text boxes, date pickers and so forth.</p></div>
<div class="paragraph"><p>One way to think of the Forms is this diagram, which shows Sections layed out in 2D physical space:</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>+---------------------+
| Section 1           |
|                     |
|                     |
|                     |
|                     |
|                     |
|                     |
+---------------------+----------------------+
| Section 2           | Section 3 - Child &lt;n&gt;|
|                     |                      |
| Children            |                      |
| o Child 1           |                      |
| o Child 2           |                      |
|                     |                      |
|                     |                      |
+---------------------+----------------------+
| Section 4           |
|                     |
|                     |
|                     |
|                     |
|                     |
|                     |
+---------------------+</tt></pre>
</div></div>
<div class="paragraph"><p>The user sees one Section at a time, and can navigate up or down to the next/prev Section.</p></div>
<div class="paragraph"><p>When navigating between the Sections the system animates the movements so as to give the
user a real sense of the physical structure of what they are editing.</p></div>
<div class="paragraph"><p>In this example Section 2 renders a list of child entities.  When clicking on an element in the list, the system
will display Section 3, with the data for the particular Child being edited.</p></div>
<div class="paragraph"><p>That list might have an <em>Add</em> button which would dynamically add another child to the list, and also a mechanism for
deleting a child from the list.</p></div>
<div class="paragraph"><p>When viewing a child in Section 3, the user can navigate left to return to the list of Children.</p></div>
<h3 id="_modules">Modules</h3><div style="clear:left"></div>
<div class="paragraph"><p>The system is modular with independent modules being responsible for different parts of the system</p></div>
<div class="tableblock">
<table rules="all"
width="60%"
frame="border"
cellspacing="0" cellpadding="4">
<caption class="title">Table 1. Modules</caption>
<col width="50%" />
<col width="50%" />
<thead>
<tr>
<th align="left" valign="top"> Module          </th>
<th align="left" valign="top"> Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table">builder</p></td>
<td align="left" valign="top"><p class="table">Form design</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">compiler</p></td>
<td align="left" valign="top"><p class="table">Compiles the form design, into a static representation that uses the runtime</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">runtime</p></td>
<td align="left" valign="top"><p class="table">Renders forms with their data, retrieving and saving data back to the datastore</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">workflow</p></td>
<td align="left" valign="top"><p class="table">Defines the steps that the information moves through</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">comms</p></td>
<td align="left" valign="top"><p class="table">Interface for external communications with users</p></td>
</tr>
</tbody>
</table>
</div>
</div>
<h2 id="builder_module">Builder Module</h2>
<div class="sectionbody">
<div class="paragraph"><p>The builder provides the components to build forms interactively or using an API.</p></div>
<div class="paragraph"><p>The result of building forms is a <a href="#df_form">[df_form]</a> data structure</p></div>
</div>
<h2 id="compiler_module">Compiler Module</h2>
<div class="sectionbody">
<div class="paragraph"><p>Takes the form as built in the <a href="#builder_module">[builder_module]</a> &amp; turns it into a different representation such as HTML and javascript
or static PDF</p></div>
</div>
<h2 id="runtime_module">Runtime Module</h2>
<div class="sectionbody">
<div class="paragraph"><p>HTML as created by the <a href="#compiler">[compiler]</a> module uses the JavaScript runtime to maintain the data being edited on the HTML pages.
It knows how to update the HTML correctly as per the users intentions and save the data back to the server.</p></div>
<h3 id="_process">Process</h3><div style="clear:left"></div>
<div class="paragraph"><p>The steps required to allow users to enter data on forms is as follows:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Design the Form
</p>
</li>
<li>
<p>
Publish the Form
</p>
</li>
<li>
<p>
Create a Document instance using the Form
</p>
</li>
</ol></div>
<div class="paragraph"><p>If we break the steps down as follows:</p></div>
<div class="paragraph"><p>Design the form
This involes the user designing the data elements to be captured on the form, along with their
data types and so forth. The result is a <a href="#df_form">[df_form]</a> document.</p></div>
<div class="paragraph" id="publish_the_form"><p>Publish the form
At this stage the <a href="#df_form">[df_form]</a> is passed through the <a href="#compiler">[compiler]</a> module, and the compiled HTML pages
stored.  Any errors during compilation will result in further form design being necessary.</p></div>
<div class="paragraph" id="create_doc_using_form"><p>Create a Document instance using the Form.
The user selects from a list of published forms, choosing the one which fulfills their needs closest,
and is presented with an (initially) empty <a href="#df_document">[df_document]</a> which they edit through the HTML pages
created when the form was published.</p></div>
</div>
<h1 id="_part_2_detailed_design">Part 2 - Detailed Design</h1>
<h2 id="data_structures">Data Structures</h2>
<div class="sectionbody">
<div class="paragraph" id="df_document"><p>df_document stores the document instance data, in JSON format.
It is persisted to and from the permanent document store.</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>df_document = {
  _id: 1,
  name: 'Dave',
  kids: '3',
  comment: 'Developer',
  employees: [
    { name: 'Sue', dob: '1970-01-01' },
    { name: 'Bob', dob: '1972-11-03' }
  ]
}</tt></pre>
</div></div>
<div class="paragraph" id="df_form"><p>df_form stores the presentation layout of the forms:</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>{
      "id": "form1",
      "sections": [
              {
                      "id": "section_1",
                      "heading": "Personal details",
                      "type": "form",
                      "fields":  [
                              { "label": "Name", "json_path": "$.name", "type": "string" },
                      { "label": "Num kids", "json_path": "$.kids",  "type": "integer" },
                      { "label": "Comment", "json_path": "$.comment",  "type": "text" }
                      ],
                      "section_navigation": { "down": "section_2" }
              },
              {
                      "id": "section_2",
                      "heading": "Employee List",
                      "type": "list",
                      "index":"employees_index",
                      "json_path": "$.employees",
                      "child_section_id": "section_3",
                      "columns":  [
                              { "label": "Name", "json_path": "name", "type": "string" },
                      { "label": "Date of birth", "json_path": "dob",  "type": "date" }
                      ],
                      "section_navigation": { "up" : "section_1" }
              },
              {
                      "id": "section_3",
                      "heading": "Employee",
                      "type": "form",
                      "fields":  [
                      { "json_path": "$.employees[employees_index].name", "type": "string" },
                      { "json_path": "$.employees[employees_index].dob", "type": "date" }
                      ],
                      "section_navigation": { "left": "section_2" }
              }
      ]
}</tt></pre>
</div></div>
<div class="paragraph"><p>When the page is rendered the user is presented with a rendering of the initial section.
Each section renders data within the document at a specific position, gathering all of its data
from the information at that point.</p></div>
<div class="paragraph"><p>The df_document stores information in a containment hierarchy, so the <em>root</em> document contains
fields <em>name</em>, <em>kids</em>, <em>comment</em> and a list of <em>employees</em>.  Each employee is contained within a specific position
within the employees list, ie: employee[0] is Sue, and employee[1] is Bob.</p></div>
<div class="paragraph"><p>Each section knows the <em>path</em> to its data, but in the case of rendering data that can be one of
many from an array (eg: a specific employee), it uses the index_cache.  When navigating into a collection,
the system records in the index_cache the index that is currently being views for each collection</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>index_cache {
  "employee_index": "2"
}</tt></pre>
</div></div>
<div class="paragraph"><p>Whenever a section is rendered, and the data (or its parents) comes from a collection, the system
recolves the collection indices using the index_cache, thus <em>employees[employee_index].name</em> becomes
<em>employees[2].name</em></p></div>
<div class="paragraph"><p>Each section knows about its surrounding sections, for displaying navigation controls.</p></div>
</div>
<h2 id="workflow_module">Workflow Module</h2>
<div class="sectionbody">
<div class="paragraph"><p>Used to define the steps that the form data travels through, etc</p></div>
</div>
<h1 id="_part_3_samples">Part 3 - Samples</h1>
<h2 id="_introduction">Introduction</h2>
<div class="sectionbody">
<div class="paragraph"><p>The samples serve to prove the concepts behind df3 will work. They are not a part of the system, but
serve as background material</p></div>
<h3 id="sample">Sample</h3><div style="clear:left"></div>
<div class="paragraph"><p>This directory contains a hand crafted HTML + Javascript sample that allows the user to edit a df_document
in place.</p></div>
<div class="paragraph"><p>It validates the use of runtime templates being used to edit a df_document maintained in a single
HTML file.  As the user navigates to different sections, the form is updated to on the fly
with a template that represents that particular section.  The data form the df_document is bound to the
form &amp; then any changes are reflected back in the df_document instance.</p></div>
<div class="paragraph"><p>Uses js templating library shotenjin.js from <a href="http://kuwata-lab.com/">http://kuwata-lab.com/</a></p></div>
<div class="paragraph"><p>Work is complete on this sample, and it confirms the approach in <a href="#create_doc_using_form">[create_doc_using_form]</a></p></div>
<h3 id="sample2">Sample2</h3><div style="clear:left"></div>
<div class="paragraph"><p>This directory contains an example that seeks to validate the process of generating HTML and javascript
templates for a specific df_form</p></div>
<div class="paragraph"><p>Executing the shell scripts will generate the equivalent hand crafted portions of <a href="#sample">[sample]</a>,
using the tenjin templating library from <a href="http://kuwata-lab.com/">http://kuwata-lab.com/</a></p></div>
<div class="paragraph"><p>This proves that the approch used to <a href="#publish_the_form">[publish_the_form]</a> will work.</p></div>
<div class="paragraph"><p>Two stages of templating occur:</p></div>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Compiling the <a href="#df_form">[df_form]</a> structure to HTML - uses rbtenjin on the server
</p>
</li>
<li>
<p>
At runtime combining the templates generated with df_data - uses jstenjin in the browser
</p>
</li>
</ol></div>
<div class="paragraph"><p>A new data structure is employed in this prototype.</p></div>
<div class="paragraph"><p>Each form represents a section, and each field is bound to the underlying data to be displayed
in that field by attaching a JSONPath to that field eg:</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>&lt;input df_jsonpath="$.name" type="text"&gt;</tt></pre>
</div></div>
<div class="paragraph"><p>At runtime the df_jsonpath attribute is extracted, and resolved against the df_data document
to retrieve the approriate data value and place that value into the &lt;input&gt;.</p></div>
<div class="paragraph"><p>Some forms represent lists of values within the df_data document. When the user selects a particular
value from the list, this will set a value in the df_index hash eg: If the user selected was presented
with a list of children:</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>Tom
Jack</tt></pre>
</div></div>
<div class="paragraph"><p>and the user selected <em>Tom</em> then the df_index hash will be populated as follows:</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>df_index {
  "child_index" : 0
}</tt></pre>
</div></div>
<div class="paragraph"><p>When the user navigates to the <em>child</em> form, the form template is constructed as follows:</p></div>
<div class="literalblock">
<div class="content">
<pre><tt>&lt;input df_jsonpath="$.children[child_index].name" type="text"&gt;</tt></pre>
</div></div>
<div class="paragraph"><p>child_index is replaced with the value in the df_index[<em>child_index</em>], in this case 0, so will resolve
to the correctly selected childs name eg: <em>Tom</em></p></div>
<div class="paragraph"><p>This sample also adds the ability to manipulate lists better.  When the section inside a df_form
has a type of "list", then the contents are rendered as an HTML table with a button to "Add" a new
row. When the button is clicked a new row is added to the array of data as identified in the "json_path"
and the user is taken to the child form, bound to the data in the new row. Note that there is no need to
fill the new row with default data.</p></div>
<div class="paragraph"><p>No validation occurs in this sample</p></div>
<div class="paragraph"><p>Work is complete on this sample and the work appears in the sample2 directory.  To build the samples
run sample2/bin/compile.sh and open the output/df_form1.html files in your browser</p></div>
<h3 id="sample3">Sample3</h3><div style="clear:left"></div>
<div class="paragraph"><p>The purpose of this sample is to explore the design and implementation of a REST api to be used by clients.</p></div>
<div class="paragraph"><p>The following API is implemented by the server:</p></div>
<div class="paragraph"><p>Note that the <em>Type</em> column refers to the concept as described in "The REST API design Book, Mark Masse"</p></div>
<div class="tableblock">
<table rules="all"
width="60%"
frame="border"
cellspacing="0" cellpadding="4">
<caption class="title">Table 2. sample3 URLs</caption>
<col width="33%" />
<col width="33%" />
<col width="33%" />
<thead>
<tr>
<th align="left" valign="top"> URL                             </th>
<th align="left" valign="top"> Type    </th>
<th align="left" valign="top"> Description</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table">http:/host/documents</p></td>
<td align="left" valign="top"><p class="table">Collection</p></td>
<td align="left" valign="top"><p class="table">List of all documents</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">http:/host/documents/1</p></td>
<td align="left" valign="top"><p class="table">Document</p></td>
<td align="left" valign="top"><p class="table">Access an individual document</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">http:/host/documents/delete-all</p></td>
<td align="left" valign="top"><p class="table">Controller</p></td>
<td align="left" valign="top"><p class="table">Delete all documents</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>The client from sample 2 is enhanced to interact with the server, initially to get the list of documents,
and then to retrieve a specific document instance, edit it and save.</p></div>
<div class="paragraph"><p>The server component is built using <em>Zappa</em>, the coffescript wrapper around <em>Express</em> for node.js.</p></div>
<div class="listingblock">
<div class="content">
<pre><tt>Source
 /server                  - server components
    /node_modules         - node modules
       /connect
       /express
       /jasmine-node
       /underscore
       /zappa
    /public               - static files served form here</tt></pre>
</div></div>
<h4 id="_execution">Execution</h4>
<div class="paragraph"><p>The process that occurs is as follows:
Note that <em>sample3</em> is the name of the CouchDB database</p></div>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<col width="33%" />
<col width="33%" />
<col width="33%" />
<tbody>
<tr>
<td align="left" valign="top"><p class="table">Browser</p></td>
<td align="left" valign="top"><p class="table">Node</p></td>
<td align="left" valign="top"><p class="table">CouchDB</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">open <a href="http://localhost:3000/index.html">http://localhost:3000/index.html</a></p></td>
<td align="left" valign="top"><p class="table">Render &amp; return template for document_list page</p></td>
<td align="left" valign="top"><p class="table"></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">onDOMReady</p></td>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table"></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table">get /documents</p></td>
<td align="left" valign="top"><p class="table"></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table">get /sample3/_design/documents/_view/all</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table">Returns a list of document &lt;uuids&gt;</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">replace contents of &lt;div&gt; with list</p></td>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table"></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table"></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">click <em>add</em> a new document</p></td>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table"></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table">post /documents (no data)</p></td>
<td align="left" valign="top"><p class="table"></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table">inject an empty document into df_form.html as df_document</p></td>
<td align="left" valign="top"><p class="table"></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">edit and click save</p></td>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table"></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table">post /documents (with data)</p></td>
<td align="left" valign="top"><p class="table"></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table">post /sample3/documents</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table">returns new document &lt;uuid&gt;</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table">get /sample3/&lt;uuid&gt;</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table">inject document data into df_form1.html as df_document</p></td>
<td align="left" valign="top"><p class="table"></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table"></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">click link to <em>edit</em> a document</p></td>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table"></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table">get /documents/&lt;uuid&gt;</p></td>
<td align="left" valign="top"><p class="table"></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table">get /sample3/&lt;uuid&gt;</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table">inject document data into df_form1.html as df_document</p></td>
<td align="left" valign="top"><p class="table"></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">edit and click save</p></td>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table"></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table">put /documents/&lt;uuid&gt;</p></td>
<td align="left" valign="top"><p class="table"></p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table"></p></td>
<td align="left" valign="top"><p class="table">put /sample3/&lt;uuid&gt;</p></td>
</tr>
</tbody>
</table>
</div>
<h4 id="_installation">Installation</h4>
<div class="ulist"><ul>
<li>
<p>
Install coffescript
</p>
</li>
<li>
<p>
Install rbtenjin
</p>
</li>
<li>
<p>
Install node
</p>
</li>
<li>
<p>
Install npm
</p>
</li>
<li>
<p>
cd sample3/server
</p>
</li>
</ul></div>
<h4 id="_execution_2">Execution</h4>
<div class="olist arabic"><ol class="arabic">
<li>
<p>
Start couchdb
</p>
<div class="olist loweralpha"><ol class="loweralpha">
<li>
<p>
as per <a href="http://couchdb.apache.org/">http://couchdb.apache.org/</a>
</p>
</li>
</ol></div>
</li>
<li>
<p>
Setup db
</p>
<div class="olist loweralpha"><ol class="loweralpha">
<li>
<p>
bin/migrate
</p>
</li>
</ol></div>
</li>
<li>
<p>
Run the app server
</p>
<div class="olist loweralpha"><ol class="loweralpha">
<li>
<p>
bin/run-server
</p>
</li>
</ol></div>
</li>
</ol></div>
</div>
<h2 id="_part_4_appendix">Appendix A: Part 4 - Appendix</h2>
<div class="sectionbody">
<h2 id="issues">Issues</h2>
<div class="sectionbody">
<div class="ulist"><ul>
<li>
<p>
In the samples, it was obvious that the runtime generation of templates was very slow.
  Can potentially speed up the generation of templates at runtime by pre-compiling them &amp; storing the
  precompiled form either on the browser or server.
</p>
</li>
</ul></div>
</div>
<h2 id="_glossary">Glossary</h2>
<div class="sectionbody">
<div class="dlist"><dl>
<dt class="hdlist1">
Workflow
</dt>
<dd>
<p>
  TODO
</p>
</dd>
</dl></div>
</div>
<h2 id="_index">Index</h2>
<div class="sectionbody">
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Version 1.0<br />
Last updated 2011-12-12 07:13:15 NZDT
</div>
</div>
</body>
</html>
